#!/usr/bin/env python3
"""Generate task-inventory.json for English oral learning APP (concept-guided mode)."""
import json
from datetime import datetime, timezone

now = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
BASE = "/home/hello/Documents/myskills/.allforai"

tasks = []
tid = 0

def T(name, role, freq, risk, main_flow, **kw):
    global tid
    tid += 1
    t = {
        "id": f"T{tid:03d}",
        "task_name": name,
        "owner_role": role,
        "frequency": freq,
        "risk_level": risk,
        "main_flow": main_flow,
        "status": "concept_guided"
    }
    for k, v in kw.items():
        t[k] = v
    tasks.append(t)

# ── R001/R002/R003 共享: 场景对话 ──
T("浏览并选择场景", "R001", "高", "低",
  ["打开场景列表", "按角色/难度/主题筛选", "查看场景简介", "选择场景"],
  value="帮用户快速找到匹配需求的场景",
  exceptions=["场景不可用→推荐相似场景", "网络错误→显示缓存列表"],
  rules=["场景按个性化推荐排序", "已完成场景标记进度"])

T("进行场景对话", "R001", "高", "中",
  ["进入场景", "语音/文字输入", "接收AI回复", "查看实时发音纠正", "收集生词"],
  value="核心交互——在场景中练习口语",
  exceptions=["语音识别失败→提示重说或切换文字", "AI响应超时→等待动画并重试", "网络断开→保存本地稍后同步"],
  rules=["每轮对话限时5分钟可配置", "生词自动收集到词汇本"])

T("查看对话报告", "R001", "高", "低",
  ["完成对话", "查看综合评分", "查看语法错误清单", "查看表达建议", "选择重新开始或结束"],
  value="让用户了解自己的表现并改进",
  exceptions=["评分生成失败→显示基础统计"])

T("进行自由对话", "R001", "中", "中",
  ["选择话题或自定义", "自由语音/文字输入", "AI自由回复", "查看反馈"],
  value="提供无场景约束的自由练习",
  exceptions=["AI生成不当内容→内容过滤替换"])

T("查看实时发音纠正", "R001", "高", "低",
  ["对话中触发发音检测", "查看音素级评分", "查看纠正建议", "播放标准发音对比"],
  value="融入对话的实时发音纠正，不打断流程")

T("查看发音详细报告", "R001", "中", "低",
  ["进入发音报告", "查看音素级评分详情", "播放标准发音对比", "查看发音趋势"],
  value="深度了解发音弱点和改善趋势")

# ── 记忆曲线 ──
T("完成记忆曲线复习", "R001", "高", "低",
  ["查看今日复习任务", "开始闪卡复习", "标记已记住/未记住", "查看复习统计"],
  value="艾宾浩斯记忆曲线确保生词不忘",
  rules=["复习间隔按记忆曲线算法计算", "每日推送复习提醒"])

T("管理词汇本", "R001", "中", "低",
  ["浏览词汇列表", "按来源/状态筛选", "查看词汇详情", "手动添加/删除词汇"],
  value="管理从对话和复习中积累的词汇")

# ── R004: 场景库管理 ──
T("创建场景对话脚本", "R004", "高", "中",
  ["新建场景", "编辑对话节点", "设置难度和适用角色", "预览场景对话", "保存草稿"],
  value="为用户提供高质量的场景内容",
  rules=["场景名不能为空", "至少3轮对话节点", "必须标定难度级别"],
  exceptions=["保存失败→自动暂存草稿"])

T("审核场景内容", "R004", "高", "中",
  ["查看待审核列表", "审核场景内容准确性", "检查文化适当性", "通过或驳回"],
  value="保证上线场景的质量和适当性",
  rules=["驳回必须填写原因", "审核通过后自动上架"],
  exceptions=["审核超时48h→自动升级提醒"])

T("管理场景包", "R004", "中", "低",
  ["查看场景包列表", "创建/编辑场景包", "上架/下架场景包", "编辑标签和关键词"],
  value="组织场景为可售卖的场景包")

T("管理场景标签", "R004", "中", "低",
  ["查看标签列表", "创建/编辑标签", "批量打标签", "管理关键词"],
  value="通过标签和关键词提升场景发现率")

# ── 游戏化与轻社交 ──
T("查看学习连胜与成就", "R001", "高", "低",
  ["查看连胜天数", "领取连胜奖励", "查看成就徽章列表", "查看成就详情"],
  value="游戏化激励持续学习",
  rules=["连续学习计算逻辑：每天至少完成1轮对话", "连胜中断可用积分恢复1次"])

T("查看排行榜", "R001", "中", "低",
  ["查看好友排名", "查看全站排名", "切换排名维度"],
  value="轻社交竞争激励学习")

T("兑换积分商品", "R001", "中", "低",
  ["查看积分余额", "浏览可兑换奖品", "兑换奖品", "查看兑换记录"],
  value="积分激励体系的出口")

T("分享学习成果", "R001", "低", "低",
  ["选择分享模板", "预览分享卡片", "分享到社交媒体"],
  value="口碑传播渠道")

# ── 学习档案与进度 ──
T("查看个人学习档案", "R001", "中", "低",
  ["查看口语能力雷达图", "查看学习目标进度", "查看历史对话列表"],
  value="让用户了解自己的整体学习状况")

T("查看学习统计报告", "R001", "中", "低",
  ["选择周/月维度", "查看学习数据", "查看开口时长趋势", "查看场景通关率"],
  value="数据驱动学习改进")

# ── 角色场景推荐 ──
T("设置角色偏好", "R001", "低", "低",
  ["选择角色类型", "设置学习目标", "选择感兴趣场景类型"],
  value="个性化推荐的基础")

T("查看个性化推荐", "R001", "高", "低",
  ["打开首页", "查看个性化推荐场景", "查看推荐理由"],
  value="帮用户快速发现适合的场景")

# ── 紧急场景速学 (R003 特色) ──
T("使用紧急场景速学", "R003", "中", "中",
  ["选择紧急场景", "查看关键句模板", "跟读练习", "收藏到词汇本"],
  value="出发前10分钟预演即将面对的场景",
  exceptions=["语音识别失败→文字替代"])

# ── 订阅与付费 ──
T("订阅付费方案", "R001", "低", "高",
  ["查看订阅方案", "选择方案", "确认支付", "完成订阅"],
  value="将免费用户转化为付费用户",
  rules=["支付前确认方案详情", "免费版每天3轮对话限制"],
  exceptions=["支付失败→提示重试", "网络错误→保存订单稍后续费"])

T("管理订阅", "R001", "低", "低",
  ["查看当前订阅", "续费/升级方案", "取消订阅"],
  exceptions=["取消订阅需二次确认弹窗"])

T("购买场景包", "R001", "低", "中",
  ["浏览可购场景包", "查看场景包详情", "购买场景包"],
  exceptions=["支付失败→重试"])

# ── R006: 运营数据看板 ──
T("查看关键指标看板", "R006", "高", "低",
  ["查看DAU/MAU/留存", "查看开口时长指标", "查看收入指标", "设置指标告警"],
  value="监控产品健康度")

T("分析用户行为", "R006", "中", "低",
  ["查看行为漏斗", "创建自定义分析", "导出分析数据"],
  value="理解用户学习行为和流失原因")

T("管理A/B测试", "R006", "中", "中",
  ["创建A/B测试", "配置测试变体", "查看测试结果", "停止/启动测试"],
  value="数据驱动产品优化",
  rules=["测试名称必填", "至少2个变体"])

T("生成运营报告", "R006", "中", "低",
  ["选择报告模板", "配置数据范围", "生成运营报告", "导出报告"],
  value="定期汇报产品运营状况")

# ── R005: AI质量监控 ──
T("查看AI对话质量评分", "R005", "高", "低",
  ["查看质量评分概览", "查看低分对话列表", "查看评分趋势"],
  value="监控AI输出质量")

T("标注异常对话", "R005", "中", "中",
  ["查看待标注对话", "标注异常类型", "提交标注"],
  value="改善AI训练数据质量",
  rules=["必须选择异常分类"])

T("管理Prompt模板", "R005", "中", "中",
  ["查看Prompt模板列表", "创建/编辑Prompt模板", "测试Prompt效果", "发布到生产环境"],
  value="优化AI场景对话质量",
  exceptions=["发布前强制预览验证"])

T("调整发音评估参数", "R005", "低", "中",
  ["查看当前评估参数", "调整音素阈值", "测试参数效果", "保存参数"],
  value="提升发音评估准确性",
  rules=["阈值范围0.0-1.0"])

# ── R007: 用户管理与系统配置 ──
T("管理用户账户", "R007", "高", "中",
  ["搜索用户", "查看用户详情", "查看用户学习档案", "封禁/解禁用户"],
  value="维护平台用户生态",
  exceptions=["封禁需二次确认"])

T("处理订阅与退款", "R007", "中", "高",
  ["查看订阅列表", "处理退款申请", "审批退款", "通知用户"],
  value="处理付费相关问题",
  rules=["退款需填写审批理由"],
  exceptions=["退款金额超限→需上级审批"])

T("配置系统参数", "R007", "低", "高",
  ["查看系统参数列表", "修改参数值", "确认修改", "查看修改日志"],
  value="运营参数热更新",
  rules=["参数修改需确认"],
  exceptions=["关键参数修改需二次确认"])

T("管理权限角色", "R007", "低", "中",
  ["查看角色列表", "创建/编辑角色权限", "分配用户角色"],
  value="精细化权限管控")

T("处理用户投诉", "R007", "中", "中",
  ["查看投诉列表", "查看投诉详情", "处理投诉", "回复用户"],
  value="维护用户满意度",
  rules=["处理结果必填"])

# ── 注册登录与个人设置 ──
T("注册账户", "R001", "低", "中",
  ["选择注册方式", "输入手机号/邮箱", "设置密码", "完成注册"],
  rules=["手机号格式校验", "密码强度要求"],
  exceptions=["手机号已注册→提示登录"])

T("登录账户", "R001", "高", "低",
  ["选择登录方式", "输入账号密码/验证码/第三方", "完成登录"],
  exceptions=["密码错误→提示重试+忘记密码"])

T("管理个人设置", "R001", "低", "低",
  ["修改头像/昵称", "修改通知偏好", "修改语言设置"],
  value="个性化用户体验")

T("重置密码", "R001", "低", "中",
  ["输入注册邮箱/手机", "接收验证码", "输入验证码", "设置新密码"],
  rules=["邮箱/手机格式校验", "密码强度要求"])

T("注销账户", "R001", "低", "高",
  ["申请注销", "确认注销", "等待冷静期", "完成注销"],
  exceptions=["注销需二次确认+等待期"],
  rules=["注销有7天冷静期", "注销后数据保留30天"])

# ── 首次体验 ──
T("完成新手引导", "R001", "低", "低",
  ["选择学习目的", "选择当前水平", "体验示范对话", "完成引导"],
  value="提升首次体验转化率")

# ── 推送与通知 ──
T("管理通知中心", "R001", "中", "低",
  ["查看学习提醒", "查看系统通知", "管理通知设置"],
  value="及时触达用户促进学习")

# ── 用户反馈 ──
T("提交意见反馈", "R001", "低", "低",
  ["选择反馈类型", "填写反馈内容", "上传截图", "提交反馈"],
  rules=["反馈内容不能为空"])

# Write task-inventory.json
config_summary = {"frontend_hardcode": 0, "code_constant": 0, "config_file": 0, "general_config": 0, "dedicated_config": 0}
output = {
    "generated_at": now,
    "mode": "concept_guided",
    "scale": "medium",
    "task_count": len(tasks),
    "config_level_summary": config_summary,
    "tasks": tasks
}
with open(f"{BASE}/product-map/task-inventory.json", "w", encoding="utf-8") as f:
    json.dump(output, f, ensure_ascii=False, indent=2)

# Stats
freq = {"高": 0, "中": 0, "低": 0}
risk = {"高": 0, "中": 0, "低": 0}
by_role = {}
for t in tasks:
    freq[t["frequency"]] += 1
    risk[t["risk_level"]] += 1
    by_role.setdefault(t["owner_role"], []).append(t["id"])

print(f"Tasks: {len(tasks)}")
print(f"Frequency: {freq}")
print(f"Risk: {risk}")
for r, tids in sorted(by_role.items()):
    print(f"  {r}: {len(tids)} tasks")
